version: 0.1
component: command
timeoutInSeconds: 10000
shell: bash
failImmediatelyOnError: true
env:
  variables:

  vaultVariables:
    aws_access_key_id: ocid1.vaultsecret.oc1.us-sanjose-1.amaaaaaayat6pyaai2imzaxryz3txkgik724kh66mahsfq57hirzw4z7zaqq
    aws_secret_access_key: ocid1.vaultsecret.oc1.us-sanjose-1.amaaaaaayat6pyaaq4skuh5smh2fbevxianlmhrfc36hklvuk7foh5f3z4aa

#inputArtifacts:
#  - name: artifact-name
#    type: GENERIC_ARTIFACT
#    artifactId: "artifact-ocid"
#    registryId: OCID of the Artifact Registry
#    path: path of the artifact in the Registry
#    version: version of the artifact
#    location: target-location
#  - name: artifact-name
#    type: URL
#    url: downloadable link
#    location: target-location

steps:
  - type: Command
    name: TerraformSetup
    shell: bash
    timeoutInSeconds: 3500
    failImmediatelyOnError: true
    command: |
      echo "[default]" > cred_store
      echo "aws_access_key_id=${aws_access_key_id}">>cred_store
      echo "aws_secret_access_key=${aws_secret_access_key}">>cred_store
      mkdir terraform
      cp cred_store terraform/cred_store
      ls -ltr ./terraform/
      echo ${OBJECT_NAMESPACE}
      echo ${OBJECT_BUCKET_NAME}
      oci os object bulk-download -ns ${OBJECT_NAMESPACE} -bn ${OBJECT_BUCKET_NAME} --download-dir ./terraform --prefix devops_ --include '*.tf'
      ls -ltr ./terraform/

    onFailure:
      - type: Command
        command: |
          echo "Handling Failure"
          echo "Failure successfully handled"
        timeoutInSeconds: 400

  - type: Command
    name: ApplyTerraform
    shell: bash
    timeoutInSeconds: 3500
    failImmediatelyOnError: true
    command: |
      cd ./terraform
      terraform version
      terraform init
      terraform plan -out plan.out
      terraform refresh
      terraform apply plan.out

    onFailure:
      - type: Command
        command: |
          echo "Handling Failure"
          echo "Failure successfully handled"
        timeoutInSeconds: 400
